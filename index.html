<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€å£“è¨˜éŒ„èˆ‡åˆ†æ</title>
    <style>
        body {
            font-family: 'Arial', 'Noto Sans TC', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        /* ç§»å‹•çš„ Emoji èƒŒæ™¯ */
        .background-icons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        .emoji {
            position: absolute;
            font-size: 40px;
            opacity: 0.2;
            animation: float 15s infinite linear;
        }
        .emoji:nth-child(1) { top: 10%; left: 5%; animation-duration: 20s; }
        .emoji:nth-child(2) { top: 30%; left: 20%; animation-duration: 25s; }
        .emoji:nth-child(3) { top: 50%; left: 40%; animation-duration: 18s; }
        .emoji:nth-child(4) { top: 70%; left: 60%; animation-duration: 22s; }
        .emoji:nth-child(5) { top: 20%; left: 80%; animation-duration: 19s; }
        @keyframes float {
            0% { transform: translate(0, 0); }
            25% { transform: translate(20px, -30px); }
            50% { transform: translate(-20px, 0); }
            75% { transform: translate(10px, 30px); }
            100% { transform: translate(0, 0); }
        }
        h1 {
            color: #007bff;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            color: #0056b3;
            font-size: 1.5em;
            margin-top: 30px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        #preview {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        button, #photoInputBtn {
            padding: 10px 20px;
            margin: 10px 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover, #photoInputBtn:hover {
            background-color: #0056b3;
        }
        #photoInput {
            display: none;
        }
        #records {
            margin-top: 20px;
        }
        .record-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .status-normal { color: #28a745; font-weight: bold; }
        .status-abnormal { color: #dc3545; font-weight: bold; }
        .analysis {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ff;
            border-radius: 5px;
            color: #0056b3;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        #latestStatus {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <!-- ç§»å‹•çš„ Emoji èƒŒæ™¯ -->
    <div class="background-icons">
        <span class="emoji">ğŸ«€</span>
        <span class="emoji">ğŸ¦¾</span>
        <span class="emoji">ğŸ«€</span>
        <span class="emoji">ğŸ¦¾</span>
        <span class="emoji">ğŸ«€</span>
    </div>

    <div class="container">
        <h1>è¡€å£“è¨˜éŒ„èˆ‡åˆ†æ</h1>
        <p style="text-align: center; color: #666;">ä¸Šå‚³ç…§ç‰‡æˆ–æ‰‹å‹•è¼¸å…¥ï¼Œéš¨æ™‚æŒæ¡æ‚¨çš„å¥åº·ç‹€æ³</p>

        <!-- æ‹ç…§èˆ‡ä¸Šå‚³ -->
        <button id="photoInputBtn">ä¸Šå‚³è¡€å£“è¨ˆç…§ç‰‡</button>
        <input type="file" id="photoInput" accept="image/*" capture="camera">
        <br>
        <img id="preview" src="" alt="é è¦½ç…§ç‰‡" style="display: none;">

        <!-- è¼¸å…¥è¡€å£“æ•¸æ“š -->
        <div class="input-group">
            <label>æ”¶ç¸®å£“ (mmHg):</label>
            <input type="number" id="systolic" placeholder="ä¾‹å¦‚: 120">
        </div>
        <div class="input-group">
            <label>èˆ’å¼µå£“ (mmHg):</label>
            <input type="number" id="diastolic" placeholder="ä¾‹å¦‚: 80">
        </div>
        <button onclick="saveRecord()">å„²å­˜è¨˜éŒ„</button>
        <div id="latestStatus"></div>

        <!-- æ­·å²è¨˜éŒ„ -->
        <h2>å€‹äººè¡€å£“ç´€éŒ„</h2>
        <div id="records"></div>

        <!-- åˆ†ææŒ‰éˆ• -->
        <button onclick="analyzeRecords()">åˆ†æå¥åº·å»ºè­°</button>
        <div id="analysisResult" class="analysis" style="display: none;"></div>
    </div>

    <script>
        // Gemini API é…ç½®
        const API_KEY = 'AIzaSyA9OEx3T2q0ahU88aPyTE8ebquRm2FSxvg';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

        // æ‹ç…§èˆ‡é è¦½
        const photoInputBtn = document.getElementById('photoInputBtn');
        const photoInput = document.getElementById('photoInput');
        const preview = document.getElementById('preview');
        photoInputBtn.addEventListener('click', () => photoInput.click());

        photoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    analyzeImageWithGemini(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // ä½¿ç”¨ Gemini API åˆ†æåœ–ç‰‡
        async function analyzeImageWithGemini(imageData) {
            const prompt = "è«‹å¾é€™å¼µè¡€å£“è¨ˆç…§ç‰‡ä¸­æå–æ”¶ç¸®å£“å’Œèˆ’å¼µå£“æ•¸å€¼ï¼Œä¸¦ä»¥æ ¼å¼ 'æ”¶ç¸®å£“: X, èˆ’å¼µå£“: Y' è¿”å›ã€‚";
            const imageBase64 = imageData.split(',')[1];

            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: imageBase64 } }
                    ]
                }]
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                console.log('Gemini çµæœ:', text);

                const numbers = text.match(/\d+/g);
                if (numbers && numbers.length >= 2) {
                    document.getElementById('systolic').value = numbers[0];
                    document.getElementById('diastolic').value = numbers[1];
                } else {
                    document.getElementById('latestStatus').innerHTML = 'ç„¡æ³•è¾¨è­˜è¡€å£“æ•¸å€¼ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚';
                    document.getElementById('latestStatus').style.backgroundColor = '#f8d7da';
                    document.getElementById('latestStatus').style.color = '#dc3545';
                }
            } catch (error) {
                console.error('éŒ¯èª¤:', error);
                document.getElementById('latestStatus').innerHTML = 'åœ–ç‰‡åˆ†æå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥è¡€å£“æ•¸æ“šã€‚';
                document.getElementById('latestStatus').style.backgroundColor = '#f8d7da';
                document.getElementById('latestStatus').style.color = '#dc3545';
            }
        }

        // å„²å­˜è¨˜éŒ„ä¸¦é¡¯ç¤ºç‹€æ…‹
        function saveRecord() {
            const systolic = parseInt(document.getElementById('systolic').value);
            const diastolic = parseInt(document.getElementById('diastolic').value);
            const latestStatusDiv = document.getElementById('latestStatus');

            if (!systolic || !diastolic) {
                latestStatusDiv.innerHTML = 'è«‹è¼¸å…¥å®Œæ•´çš„è¡€å£“æ•¸æ“šã€‚';
                latestStatusDiv.style.backgroundColor = '#f8d7da';
                latestStatusDiv.style.color = '#dc3545';
                return;
            }

            const status = checkBloodPressure(systolic, diastolic);
            const record = {
                date: new Date().toLocaleString(),
                systolic: systolic,
                diastolic: diastolic,
                status: status
            };

            let records = JSON.parse(localStorage.getItem('bpRecords')) || [];
            records.push(record);
            localStorage.setItem('bpRecords', JSON.stringify(records));

            // é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
            latestStatusDiv.innerHTML = `æœ¬æ¬¡è¡€å£“: ${status}`;
            latestStatusDiv.style.backgroundColor = status === 'æ­£å¸¸' ? '#d4edda' : '#f8d7da';
            latestStatusDiv.style.color = status === 'æ­£å¸¸' ? '#28a745' : '#dc3545';

            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
            document.getElementById('photoInput').value = '';
            preview.src = '';
            preview.style.display = 'none';

            displayRecords();
        }

        // æª¢æ¸¬è¡€å£“æ˜¯å¦æ­£å¸¸
        function checkBloodPressure(systolic, diastolic) {
            if (systolic < 120 && diastolic < 80) return "æ­£å¸¸";
            if (systolic <= 129 && diastolic < 80) return "åé«˜";
            if (systolic <= 139 || diastolic <= 89) return "é«˜è¡€å£“ 1 æœŸ";
            return "é«˜è¡€å£“ 2 æœŸ";
        }

        // é¡¯ç¤ºæ­·å²ç´€éŒ„
        function displayRecords() {
            const recordsDiv = document.getElementById('records');
            let records = JSON.parse(localStorage.getItem('bpRecords')) || [];
            
            recordsDiv.innerHTML = '';
            records.forEach((record) => {
                recordsDiv.innerHTML += `
                    <div class="record-item">
                        <p>æ—¥æœŸ: ${record.date}</p>
                        <p>æ”¶ç¸®å£“: ${record.systolic} mmHg, èˆ’å¼µå£“: ${record.diastolic} mmHg 
                            (<span class="${record.status === 'æ­£å¸¸' ? 'status-normal' : 'status-abnormal'}">${record.status}</span>)</p>
                    </div>
                `;
            });
        }

        // åˆ†æç´€éŒ„ä¸¦çµ¦å»ºè­°
        async function analyzeRecords() {
            const records = JSON.parse(localStorage.getItem('bpRecords')) || [];
            if (records.length === 0) {
                document.getElementById('analysisResult').innerHTML = 'å°šç„¡ç´€éŒ„å¯åˆ†æã€‚';
                document.getElementById('analysisResult').style.display = 'block';
                return;
            }

            const prompt = `ä»¥ä¸‹æ˜¯æˆ‘çš„è¡€å£“ç´€éŒ„ï¼Œè«‹åˆ†æä¸¦æä¾›å¥åº·å»ºè­°ï¼ˆè«‹ä½¿ç”¨æ¸…æ™°çš„æ®µè½åˆ†éš”ï¼‰ï¼š\n${records.map(r => `${r.date}: æ”¶ç¸®å£“ ${r.systolic} mmHg, èˆ’å¼µå£“ ${r.diastolic} mmHg`).join('\n')}`;
            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');

                const data = await response.json();
                let advice = data.candidates[0].content.parts[0].text;
                advice = advice.replace(/\n/g, '<br>');
                document.getElementById('analysisResult').innerHTML = `<strong>å¥åº·å»ºè­°ï¼š</strong><br>${advice}`;
                document.getElementById('analysisResult').style.display = 'block';
            } catch (error) {
                console.error('éŒ¯èª¤:', error);
                document.getElementById('analysisResult').innerHTML = 'åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                document.getElementById('analysisResult').style.display = 'block';
            }
        }

        window.onload = displayRecords;
    </script>
</body>
</html>