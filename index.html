<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>血壓記錄與分析</title>
    <style>
        body {
            font-family: 'Arial', 'Noto Sans TC', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        /* 移動的 Emoji 背景 */
        .background-icons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        .emoji {
            position: absolute;
            font-size: 40px;
            opacity: 0.2;
            animation: float 15s infinite linear;
        }
        .emoji:nth-child(1) { top: 10%; left: 5%; animation-duration: 20s; }
        .emoji:nth-child(2) { top: 30%; left: 20%; animation-duration: 25s; }
        .emoji:nth-child(3) { top: 50%; left: 40%; animation-duration: 18s; }
        .emoji:nth-child(4) { top: 70%; left: 60%; animation-duration: 22s; }
        .emoji:nth-child(5) { top: 20%; left: 80%; animation-duration: 19s; }
        @keyframes float {
            0% { transform: translate(0, 0); }
            25% { transform: translate(20px, -30px); }
            50% { transform: translate(-20px, 0); }
            75% { transform: translate(10px, 30px); }
            100% { transform: translate(0, 0); }
        }
        h1 {
            color: #007bff;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            color: #0056b3;
            font-size: 1.5em;
            margin-top: 30px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        #preview {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        button, #photoInputBtn {
            padding: 10px 20px;
            margin: 10px 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover, #photoInputBtn:hover {
            background-color: #0056b3;
        }
        #photoInput {
            display: none;
        }
        #records {
            margin-top: 20px;
        }
        .record-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .status-normal { color: #28a745; font-weight: bold; }
        .status-abnormal { color: #dc3545; font-weight: bold; }
        .analysis {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ff;
            border-radius: 5px;
            color: #0056b3;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        #latestStatus {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <!-- 移動的 Emoji 背景 -->
    <div class="background-icons">
        <span class="emoji">🫀</span>
        <span class="emoji">🦾</span>
        <span class="emoji">🫀</span>
        <span class="emoji">🦾</span>
        <span class="emoji">🫀</span>
    </div>

    <div class="container">
        <h1>血壓記錄與分析</h1>
        <p style="text-align: center; color: #666;">上傳照片或手動輸入，隨時掌握您的健康狀況</p>

        <!-- 拍照與上傳 -->
        <button id="photoInputBtn">上傳血壓計照片</button>
        <input type="file" id="photoInput" accept="image/*" capture="camera">
        <br>
        <img id="preview" src="" alt="預覽照片" style="display: none;">

        <!-- 輸入血壓數據 -->
        <div class="input-group">
            <label>收縮壓 (mmHg):</label>
            <input type="number" id="systolic" placeholder="例如: 120">
        </div>
        <div class="input-group">
            <label>舒張壓 (mmHg):</label>
            <input type="number" id="diastolic" placeholder="例如: 80">
        </div>
        <button onclick="saveRecord()">儲存記錄</button>
        <div id="latestStatus"></div>

        <!-- 歷史記錄 -->
        <h2>個人血壓紀錄</h2>
        <div id="records"></div>

        <!-- 分析按鈕 -->
        <button onclick="analyzeRecords()">分析健康建議</button>
        <div id="analysisResult" class="analysis" style="display: none;"></div>
    </div>

    <script>
        // Gemini API 配置
        const API_KEY = 'AIzaSyA9OEx3T2q0ahU88aPyTE8ebquRm2FSxvg';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

        // 拍照與預覽
        const photoInputBtn = document.getElementById('photoInputBtn');
        const photoInput = document.getElementById('photoInput');
        const preview = document.getElementById('preview');
        photoInputBtn.addEventListener('click', () => photoInput.click());

        photoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    analyzeImageWithGemini(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // 使用 Gemini API 分析圖片
        async function analyzeImageWithGemini(imageData) {
            const prompt = "請從這張血壓計照片中提取收縮壓和舒張壓數值，並以格式 '收縮壓: X, 舒張壓: Y' 返回。";
            const imageBase64 = imageData.split(',')[1];

            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: imageBase64 } }
                    ]
                }]
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('API 請求失敗');

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                console.log('Gemini 結果:', text);

                const numbers = text.match(/\d+/g);
                if (numbers && numbers.length >= 2) {
                    document.getElementById('systolic').value = numbers[0];
                    document.getElementById('diastolic').value = numbers[1];
                } else {
                    document.getElementById('latestStatus').innerHTML = '無法辨識血壓數值，請手動輸入。';
                    document.getElementById('latestStatus').style.backgroundColor = '#f8d7da';
                    document.getElementById('latestStatus').style.color = '#dc3545';
                }
            } catch (error) {
                console.error('錯誤:', error);
                document.getElementById('latestStatus').innerHTML = '圖片分析失敗，請手動輸入血壓數據。';
                document.getElementById('latestStatus').style.backgroundColor = '#f8d7da';
                document.getElementById('latestStatus').style.color = '#dc3545';
            }
        }

        // 儲存記錄並顯示狀態
        function saveRecord() {
            const systolic = parseInt(document.getElementById('systolic').value);
            const diastolic = parseInt(document.getElementById('diastolic').value);
            const latestStatusDiv = document.getElementById('latestStatus');

            if (!systolic || !diastolic) {
                latestStatusDiv.innerHTML = '請輸入完整的血壓數據。';
                latestStatusDiv.style.backgroundColor = '#f8d7da';
                latestStatusDiv.style.color = '#dc3545';
                return;
            }

            const status = checkBloodPressure(systolic, diastolic);
            const record = {
                date: new Date().toLocaleString(),
                systolic: systolic,
                diastolic: diastolic,
                status: status
            };

            let records = JSON.parse(localStorage.getItem('bpRecords')) || [];
            records.push(record);
            localStorage.setItem('bpRecords', JSON.stringify(records));

            // 顯示最新狀態
            latestStatusDiv.innerHTML = `本次血壓: ${status}`;
            latestStatusDiv.style.backgroundColor = status === '正常' ? '#d4edda' : '#f8d7da';
            latestStatusDiv.style.color = status === '正常' ? '#28a745' : '#dc3545';

            // 清空輸入
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
            document.getElementById('photoInput').value = '';
            preview.src = '';
            preview.style.display = 'none';

            displayRecords();
        }

        // 檢測血壓是否正常
        function checkBloodPressure(systolic, diastolic) {
            if (systolic < 120 && diastolic < 80) return "正常";
            if (systolic <= 129 && diastolic < 80) return "偏高";
            if (systolic <= 139 || diastolic <= 89) return "高血壓 1 期";
            return "高血壓 2 期";
        }

        // 顯示歷史紀錄
        function displayRecords() {
            const recordsDiv = document.getElementById('records');
            let records = JSON.parse(localStorage.getItem('bpRecords')) || [];
            
            recordsDiv.innerHTML = '';
            records.forEach((record) => {
                recordsDiv.innerHTML += `
                    <div class="record-item">
                        <p>日期: ${record.date}</p>
                        <p>收縮壓: ${record.systolic} mmHg, 舒張壓: ${record.diastolic} mmHg 
                            (<span class="${record.status === '正常' ? 'status-normal' : 'status-abnormal'}">${record.status}</span>)</p>
                    </div>
                `;
            });
        }

        // 分析紀錄並給建議
        async function analyzeRecords() {
            const records = JSON.parse(localStorage.getItem('bpRecords')) || [];
            if (records.length === 0) {
                document.getElementById('analysisResult').innerHTML = '尚無紀錄可分析。';
                document.getElementById('analysisResult').style.display = 'block';
                return;
            }

            const prompt = `以下是我的血壓紀錄，請分析並提供健康建議（請使用清晰的段落分隔）：\n${records.map(r => `${r.date}: 收縮壓 ${r.systolic} mmHg, 舒張壓 ${r.diastolic} mmHg`).join('\n')}`;
            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('API 請求失敗');

                const data = await response.json();
                let advice = data.candidates[0].content.parts[0].text;
                advice = advice.replace(/\n/g, '<br>');
                document.getElementById('analysisResult').innerHTML = `<strong>健康建議：</strong><br>${advice}`;
                document.getElementById('analysisResult').style.display = 'block';
            } catch (error) {
                console.error('錯誤:', error);
                document.getElementById('analysisResult').innerHTML = '分析失敗，請稍後再試。';
                document.getElementById('analysisResult').style.display = 'block';
            }
        }

        window.onload = displayRecords;
    </script>
</body>
</html>